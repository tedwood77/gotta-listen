# üöÄ Automatic Deployment Guide for Gotta Listen

This guide will help you set up automatic deployment so that changes you make in v0 (or push to GitHub) will automatically update your server.

## üéØ What This Does

When you push changes to your GitHub repository, your server will automatically:
- ‚úÖ Pull the latest code
- ‚úÖ Install/update dependencies
- ‚úÖ Run database migrations
- ‚úÖ Build the application
- ‚úÖ Restart the app
- ‚úÖ Verify everything works

## üîß Setup Methods

### Method 1: GitHub Webhooks (Recommended)
**Best for**: Automatic updates when you push to GitHub

### Method 2: Cron Jobs
**Best for**: Scheduled updates (every 5 minutes, hourly, etc.)

### Method 3: Manual Trigger
**Best for**: On-demand updates when you want them

---

## üìã Prerequisites

Before setting up auto-deployment, make sure you have:

- ‚úÖ Server with SSH access
- ‚úÖ Git repository (GitHub, GitLab, etc.)
- ‚úÖ PM2 installed and running your app
- ‚úÖ Nginx configured (optional but recommended)

---

## üöÄ Method 1: GitHub Webhooks Setup

### Step 1: Run Setup Script on Your Server

\`\`\`bash
# SSH into your server
ssh your-username@your-server-ip

# Navigate to your app directory
cd /var/www/gotta-listen

# Run the auto-deployment setup
bash scripts/setup-auto-deploy.sh
\`\`\`

The script will ask you for:
- **GitHub repository URL**: `https://github.com/yourusername/gotta-listen.git`
- **Webhook port**: `9000` (default)
- **Server domain/IP**: Your server's domain or IP address

### Step 2: Configure GitHub Webhook

1. Go to your GitHub repository
2. Click **Settings** ‚Üí **Webhooks** ‚Üí **Add webhook**
3. Fill in the details:
   - **Payload URL**: `http://your-server-ip:9000/webhook` (or `http://webhook.yourdomain.com/webhook` if using Nginx)
   - **Content type**: `application/json`
   - **Secret**: The secret generated by the setup script
   - **Events**: Select "Just the push event"
   - **Active**: ‚úÖ Checked

4. Click **Add webhook**

### Step 3: Test the Setup

\`\`\`bash
# Test the deployment system
bash scripts/test-deploy.sh

# Check webhook server status
pm2 status

# View logs
pm2 logs gotta-listen-webhook
\`\`\`

---

## ‚è∞ Method 2: Cron Jobs Setup

If you prefer scheduled updates instead of webhooks:

### Create Cron Job

\`\`\`bash
# Edit crontab
crontab -e

# Add one of these lines:

# Every 5 minutes
*/5 * * * * cd /var/www/gotta-listen && bash scripts/auto-deploy.sh >> /var/log/gotta-listen-cron.log 2>&1

# Every hour
0 * * * * cd /var/www/gotta-listen && bash scripts/auto-deploy.sh >> /var/log/gotta-listen-cron.log 2>&1

# Every day at 2 AM
0 2 * * * cd /var/www/gotta-listen && bash scripts/auto-deploy.sh >> /var/log/gotta-listen-cron.log 2>&1
\`\`\`

---

## üéÆ Method 3: Manual Trigger

For on-demand deployments:

### SSH Command
\`\`\`bash
ssh your-username@your-server-ip "cd /var/www/gotta-listen && bash scripts/auto-deploy.sh"
\`\`\`

### Web Interface (Optional)
You can create a simple web interface to trigger deployments:

\`\`\`bash
# Create a simple deployment trigger
echo '#!/bin/bash
cd /var/www/gotta-listen && bash scripts/auto-deploy.sh
' > /usr/local/bin/deploy-gotta-listen

chmod +x /usr/local/bin/deploy-gotta-listen
\`\`\`

---

## üìä Monitoring & Logs

### View Deployment Logs
\`\`\`bash
# Real-time deployment logs
tail -f /var/log/gotta-listen-deploy.log

# Webhook server logs
pm2 logs gotta-listen-webhook

# Application logs
pm2 logs gotta-listen
\`\`\`

### Check Status
\`\`\`bash
# Check all PM2 processes
pm2 status

# Check webhook server health
curl http://localhost:9000/health

# Check application health
curl http://localhost:3000/api/health
\`\`\`

---

## üîß Configuration Files

### Environment Variables for Webhook
The setup creates `.env.webhook` with:
\`\`\`env
WEBHOOK_PORT=9000
WEBHOOK_SECRET=your-generated-secret
NODE_ENV=production
\`\`\`

### PM2 Ecosystem File
The setup creates `ecosystem.config.js` with both your app and webhook server.

---

## üõ†Ô∏è Troubleshooting

### Webhook Not Triggering
1. Check GitHub webhook delivery logs
2. Verify webhook secret matches
3. Check firewall allows webhook port
4. Verify webhook server is running: `pm2 status`

### Deployment Fails
1. Check deployment logs: `tail -f /var/log/gotta-listen-deploy.log`
2. Verify Git repository access
3. Check database connection
4. Verify PM2 app name matches

### Permission Issues
\`\`\`bash
# Fix ownership
sudo chown -R $USER:$USER /var/www/gotta-listen
sudo chown -R $USER:$USER /var/log/gotta-listen*
sudo chown -R $USER:$USER /var/backups/gotta-listen
\`\`\`

### Port Issues
\`\`\`bash
# Check if port is in use
sudo netstat -tlnp | grep :9000

# Kill process using port
sudo kill -9 $(sudo lsof -t -i:9000)
\`\`\`

---

## üîí Security Considerations

### Webhook Security
- ‚úÖ Uses HMAC-SHA256 signature verification
- ‚úÖ Only accepts push events from allowed branches
- ‚úÖ Validates payload structure
- ‚úÖ Rate limiting (built into GitHub)

### Server Security
- ‚úÖ Runs as non-root user
- ‚úÖ Creates backups before deployment
- ‚úÖ Validates deployment success
- ‚úÖ Logs all activities

### Firewall Rules
\`\`\`bash
# Only allow webhook port from GitHub IPs (optional)
# Get GitHub IP ranges from: https://api.github.com/meta

# Example UFW rules
sudo ufw allow from 192.30.252.0/22 to any port 9000
sudo ufw allow from 185.199.108.0/22 to any port 9000
\`\`\`

---

## üìà Advanced Features

### Slack Notifications
Add to `auto-deploy.sh`:
\`\`\`bash
send_slack_notification() {
    local message="$1"
    curl -X POST -H 'Content-type: application/json' \
        --data "{\"text\":\"üöÄ Gotta Listen: $message\"}" \
        YOUR_SLACK_WEBHOOK_URL
}
\`\`\`

### Rollback Capability
\`\`\`bash
# List available backups
ls -la /var/backups/gotta-listen/

# Rollback to previous version
bash scripts/rollback.sh 20240115_143022
\`\`\`

### Blue-Green Deployment
For zero-downtime deployments, you can modify the script to:
1. Deploy to a staging directory
2. Test the staging version
3. Switch traffic to staging
4. Keep old version as backup

---

## üéâ You're All Set!

Now when you make changes in v0 and push to GitHub, your server will automatically update! 

### Quick Test:
1. Make a small change in v0
2. Push to GitHub
3. Watch your server logs: `tail -f /var/log/gotta-listen-deploy.log`
4. Visit your site to see the changes

### Need Help?
- Check the troubleshooting section above
- View logs for error details
- Test individual components
- Verify all prerequisites are met

Your Gotta Listen app now has **continuous deployment**! üéµ‚ú®
